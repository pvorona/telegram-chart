<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <link rel="stylesheet" href="./checkbox-button.css">
</head>
<body>
  <script type="text/javascript" src="./util.js"></script>
  <script type="text/javascript" src="./canvas-renderer.js"></script>
  <!-- <script type="text/javascript" src="./data.js"></script> -->
  <script type="text/javascript" src="./input.js"></script>

  <style>
    body {
      margin: 0;
      padding: 40px;
      user-select: none;
    }

    .container {
      position: relative;
    }

    .vertical-legend {
      position: relative;
    }

    .vertical-legend__item {
      position: absolute;
      color: #A4AAB0;
      font-size: 13px;
    }

    .horizontal-legend {
      position: absolute;
      bottom: 0;
    }

    .horizontal-legend__item {
      position: absolute;
      color: #A4AAB0;
      font-size: 13px;
    }

    .frame__container {
      margin-top: 40px;
      position: relative;
      width: 1360;
    }

    .frame {
      width: 1360;
      position: absolute;
      top: 0;
      border: 1px solid black;
      bottom: 0;
      right: 0;
      left: 0;
    }

    .frame__resizer {
      background-color: #E3ECF2;
    }

    .frame__resizer-left {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 8px;
      cursor: w-resize;
    }

    .frame__resizer-right {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 8px;
      cursor: e-resize;
    }

    .frame__background-left {
      position: absolute;
      background: #F6FAFC;
      left: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
    }

    .frame__background-right {
      position: absolute;
      background: #F6FAFC;
      right: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
    }

    .cursor-w-resize {
      cursor: w-resize !important;
    }

    .cursor-e-resize {
      cursor: e-resize !important;
    }

    .cursor-grabbing {
      cursor: grabbing !important;
    }

    .framer {
      border-top: 4px solid #E3ECF2;
      border-bottom: 4px solid #E3ECF2;
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
      cursor: grab;
    }

    .hidden {
      opacity: 0;
    }

    .layer {
      will-change: opacity;
    }
  </style>
  <div class="container">
    <div class="vertical-legend">
      <div class="vertical-legend__item">1</div>
      <div class="vertical-legend__item">2</div>
      <div class="vertical-legend__item">3</div>
      <div class="vertical-legend__item">4</div>
      <div class="vertical-legend__item">5</div>
    </div>
    <div class="horizontal-legend">
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
    </div>
    <div class="layers-container" style="width: 1360px; height: 480px; position: relative;">
      <!-- <svg id="svg" width="1360" height="480" xmlns="http://www.w3.org/2000/svg"></svg> -->

      <canvas
        id="canvas"
        style="position: absolute; width: 1360px; height: 480px"
        width="2720"
        height="960"
        class="layer"
      ></canvas>
      <canvas
        id="line-2"
        style="position: absolute; width: 1360px; height: 480px"
        width="2720"
        height="960"
        class="layer"
      ></canvas>
    </div>
  </div>
  <div class="frame__container">
    <div style="width: 1360px; height: 100px">
      <canvas
        id="frame"
        style="position: absolute; width: 1360px; height: 100px;"
        width="2720"
        height="200"
        class="layer"
      ></canvas>
      <canvas
        id="frame-2"
        style="position: absolute; width: 1360px; height: 100px;"
        width="2720"
        height="200"
        class="layer"
      ></canvas>
    </div>
    <!-- <div class="frame"> -->
      <div class="frame__background-left"></div>
      <div class="frame__background-right"></div>
      <div class="framer" id="framer">
        <div class="frame__resizer frame__resizer-left"></div>
        <div class="frame__resizer frame__resizer-right"></div>
      </div>
    <!-- </div> -->
  </div>
  <div style="margin-top: 20px;">
    <label style="color: #3DC23F">
      <input checked onClick="onButtonClick(1)" type="checkbox" class="button">
      <div class="like-button"><div class="button-text">Joined</div></div>
    </label>
    <label style="color: #F34C44; margin-left: 20px;">
      <input checked onClick="onButtonClick(2)" type="checkbox" class="button">
      <div class="like-button"><div class="button-text">Left</div></div>
    </label>
  </div>
  <script>

    function onButtonClick (graphName) {
      IN.visibilityState[graphName] = !IN.visibilityState[graphName]
      IN.canvases[graphName].classList.toggle('hidden')
      IN.frameCanvases[graphName].classList.toggle('hidden')
      render()
    }

    const LEGEND_FONT_SIZE = 13
    const LEGEND_PADDING = 5
    const LIMIT = 1000
    // data1 = [10, 8, 15, 13, 5, 8, 9, 4, 13, 4, 18, 45]
    // data2 = [7, 5, 9, 13, 18, 21, 24, 20, 36, 48, 45, 53]
    data1 = data.columns[1].slice(1)
    data2 = data.columns[2].slice(1)
    // data1 = data.slice(0, LIMIT)
    // data2 = data.slice(LIMIT, LIMIT * 2)

    const IN = {
      data: {
        1: data1,
        2: data2,
        total: data1.length,
      },
      graphNames: [1, 2],
      canvases: {
        1: document.querySelector('#canvas'),
        2: document.querySelector('#line-2'),
      },
      frameCanvases: {
        1: document.querySelector('#frame'),
        2: document.querySelector('#frame-2'),
      },
      colors: {
        1: '#FF684D',
        2: '#47B44D',
      },
      contexts: {
        1: document.querySelector('#canvas').getContext('2d'),
        2: document.querySelector('#line-2').getContext('2d'),
      },
      frameContexts: {
        1: document.querySelector('#frame').getContext('2d'),
        2: document.querySelector('#frame-2').getContext('2d'),
      },
      visibilityState: {
        1: true,
        2: true,
      },
      renderWindow: {
        startIndex: 0,
        endIndex: data1.length - 1,
      },
      devicePixelRatio: window.devicePixelRatio,
    }

    renderFrame()
    render()

    function renderFrame () {
      const arrayOfDataArrays = IN.graphNames.reduce((reduced, graphName) => [...reduced, IN.data[graphName]], [])
      const max = getMaxValue(IN.renderWindow, ...arrayOfDataArrays)
      for (const graphName of IN.graphNames) {
        renderPath(
          mapDataToCoords(IN.data[graphName], max, IN.frameCanvases[graphName], IN.renderWindow),
          IN.colors[graphName],
          IN.frameContexts[graphName],
        )
      }
    }

    function render () {
      // requestAnimationFrame(function () {
        // console.time('render')
        const visibleGraphNames = IN.graphNames.filter(graphName => IN.visibilityState[graphName])
        const arrayOfDataArrays = visibleGraphNames.reduce((reduced, graphName) => [...reduced, IN.data[graphName]], [])
        const max = getMaxValue(IN.renderWindow, ...arrayOfDataArrays)
        for (const graphName of visibleGraphNames) {
          clearCanvas(IN.contexts[graphName])
          renderPath(
            mapDataToCoords(IN.data[graphName], max, IN.canvases[graphName], IN.renderWindow),
            IN.colors[graphName],
            IN.contexts[graphName],
          )
        }
        // console.timeEnd('render')
      //})
    }

    function clearCanvas (context) {
      context.clearRect(0, 0, canvas.width, canvas.height)
    }

    // O(1)
    // function renderLattice (numberOfLines) {
    //   const screenStep = geometry.height / numberOfLines

    //   context.strokeStyle = '#F5F5F5'
    //   for (let i = 0; i < numberOfLines; i++) {
    //     context.beginPath();
    //     context.moveTo(0, geometry.height - screenStep * i - 1);
    //     context.lineTo(geometry.width, geometry.height - screenStep * i - 1)
    //     context.stroke();
    //   }
    // }

    // O(1)
    // function renderVerticalLegend (max, numberOfLines) {
    //   const valueStep = max / numberOfLines
    //   const screenStep = geometry.height / numberOfLines
    //   const legendItems = [...document.querySelectorAll('.vertical-legend__item')]

    //   for (let i = 0; i < numberOfLines; i++) {
    //     legendItems[i].innerText = valueStep * i
    //     legendItems[i].style = `top: ${geometry.height - screenStep * i - 1 - LEGEND_FONT_SIZE - LEGEND_PADDING}px;`
    //   }
    // }

    // function renderHorizontalLegend () {}


    // O(n)
    function mapDataToCoords (data, max, targetContainer, { startIndex, endIndex }) {
      const coords = []
      for (let i = startIndex; i <= endIndex; i++) {
        coords.push({
          x: targetContainer.width / (endIndex - startIndex) * (i - startIndex),
          y: targetContainer.height - targetContainer.height / max * data[i],
        })
      }
      return coords
    }


  </script>
  <script type="text/javascript" src="./frame.js"></script>
  <script>
    initFrame()
  </script>
</body>
</html>