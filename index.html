<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>
  <!-- <script type="text/javascript" src="./data.js"></script> -->
  <script type="text/javascript" src="./util.js"></script>
  <script type="text/javascript" src="./input.js"></script>

  <style>
    body {
      margin: 0;
      padding: 40px;
      user-select: none;
    }

    .container {
      position: relative;
    }

    .vertical-legend {
      position: relative;
    }

    .vertical-legend__item {
      position: absolute;
      color: #A4AAB0;
      font-size: 13px;
    }

    .horizontal-legend {
      position: absolute;
      bottom: 0;
    }

    .horizontal-legend__item {
      position: absolute;
      color: #A4AAB0;
      font-size: 13px;
    }

    .frame__container {
      margin-top: 40px;
      position: relative;
      width: 1024px;
    }

    .frame {
      width: 1024px;
      position: absolute;
      top: 0;
      border: 1px solid black;
      bottom: 0;
      right: 0;
      left: 0;
    }

    .frame__resizer {
      background-color: #E3ECF2;
    }

    .frame__resizer-left {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 8px;
      cursor: w-resize;
    }

    .frame__resizer-right {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 8px;
      cursor: e-resize;
    }

    .frame__background-left {
      position: absolute;
      background: #F6FAFC;
      left: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
    }

    .frame__background-right {
      position: absolute;
      background: #F6FAFC;
      right: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
    }

    .cursor-w-resize {
      cursor: w-resize !important;
    }

    .cursor-e-resize {
      cursor: e-resize !important;
    }

    .cursor-grabbing {
      cursor: grabbing !important;
    }

    .framer {
      border-top: 4px solid #E3ECF2;
      border-bottom: 4px solid #E3ECF2;
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      opacity: .8;
      cursor: grab;
    }
  </style>
  <div class="container">
    <div class="vertical-legend">
      <div class="vertical-legend__item">1</div>
      <div class="vertical-legend__item">2</div>
      <div class="vertical-legend__item">3</div>
      <div class="vertical-legend__item">4</div>
      <div class="vertical-legend__item">5</div>
    </div>
    <div class="horizontal-legend">
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
      <div class="horizontal-legend__item"></div>
    </div>
    <canvas
      id="canvas"
      width="1024"
      height="480"
    ></canvas>
  </div>
  <div class="frame__container">
    <canvas
      id="frame"
      width="1024"
      height="100"
    ></canvas>
    <!-- <div class="frame"> -->
      <div class="frame__background-left"></div>
      <div class="frame__background-right"></div>
      <div class="framer" id="framer">
        <div class="frame__resizer frame__resizer-left"></div>
        <div class="frame__resizer frame__resizer-right"></div>
      </div>
    <!-- </div> -->
  </div>

  <script>
    const LEGEND_FONT_SIZE = 13
    const LEGEND_PADDING = 5
    // const LIMIT = 1000000
    // data1 = [10, 8, 15, 13, 5, 8, 9, 4, 13, 4, 18, 45]
    // data1 = data.slice(0, LIMIT)
    data1 = data.columns[1].slice(1)
    data2 = data.columns[2].slice(1)
    // data1 = data.slice(0, 60)
    // data2 = [7, 5, 9, 13, 18, 21, 24, 20, 36, 48, 45, 53]
    // data2 = data.slice(LIMIT, LIMIT * 2)

    // const path = {
    //   points, color,
    // }

    const renderWindow = {
      startIndex: 0,
      endIndex: data1.length - 1,
      total: data1.length - 1,
    }

    const context = canvas.getContext('2d')
    const frameContext = frame.getContext('2d')
    let frameRendered = false

    const geometry = {
      width: canvas.width,
      height: canvas.height,
      frameWidth: frame.width,
      frameHeight: frame.height,
    }
    render()

    function render (input = [
      { data: data1, color: data.colors['y0'] },
      { data: data2, color: data.colors['y1'] },
      // { data: data1, color: '#FF684D' },
      // { data: data2, color: '#47B44D' },
    ], renderWindow) {
      console.time('render')
      context.clearRect(0, 0, canvas.width, canvas.height);
      const max = findMaxValue([...input[0].data, ...input[1].data])
      renderLattice(5)
      renderVerticalLegend(max, 5)
      renderHorizontalLegend()
      renderPaths(input, max, renderWindow)
      frameRendered = true
      console.timeEnd('render')
    }

    // O(1)
    function renderLattice (numberOfLines) {
      const screenStep = geometry.height / numberOfLines

      context.strokeStyle = '#F5F5F5'
      for (let i = 0; i < numberOfLines; i++) {
        context.beginPath();
        context.moveTo(0, geometry.height - screenStep * i - 1);
        context.lineTo(geometry.width, geometry.height - screenStep * i - 1)
        context.stroke();
      }
    }

    // O(1)
    function renderVerticalLegend (max, numberOfLines) {
      const valueStep = max / numberOfLines
      const screenStep = geometry.height / numberOfLines
      const legendItems = [...document.querySelectorAll('.vertical-legend__item')]

      for (let i = 0; i < numberOfLines; i++) {
        legendItems[i].innerText = valueStep * i
        legendItems[i].style = `top: ${geometry.height - screenStep * i - 1 - LEGEND_FONT_SIZE - LEGEND_PADDING}px;`
      }
    }

    function renderHorizontalLegend () {}

    // O(n) + O(n) ~ O(n)
    function renderPaths (input, max, renderWindow) {
      for (const { data, color } of input) {
        const points = mapDataToCoords(data, max, renderWindow)
        renderPath({ points, color })
      }
    }

    // O(n)
    function mapDataToCoords (data, max, { startIndex = 0, endIndex = data.length - 1 } = {}) {
      const coords = []
      for (let i = startIndex; i <= endIndex; i++) {
        coords.push({
          x: geometry.width / (endIndex - startIndex) * (i - startIndex),
          y: geometry.height - geometry.height / max * data[i],
          frameX: geometry.frameWidth / (endIndex - startIndex) * (i - startIndex),
          frameY: geometry.frameHeight - geometry.frameHeight / max * data[i],
        })
      }
      return coords
    }

    function renderPath ({ points, color }) {
      context.beginPath();
      context.strokeStyle = color

      if (!frameRendered) {
        frameContext.beginPath();
        frameContext.strokeStyle = color
      }

      // const legendItems = [...document.querySelectorAll('.horizontal-legend__item')]

      for (let i = 0; i < points.length; i++) {
        const { x, y, frameX, frameY } = points[i]
        context.lineTo(x, y)
        if (!frameRendered) {
          frameContext.lineTo(frameX, frameY)
        }

        // legendItems[i].innerText = i
        // legendItems[i].style = `left: ${x}px;`
      }

      context.stroke()
      if (!frameRendered) {
        frameContext.stroke()
      }
    }

  </script>
  <script type="text/javascript" src="./frame.js"></script>
  <script>
    initFrame()
  </script>
</body>
</html>